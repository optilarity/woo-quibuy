(()=>{"use strict";var t=function(){function t(){var t,e;this.modal=document.getElementById("woo-quibuy-modal"),this.closeBtn=(null===(t=this.modal)||void 0===t?void 0:t.querySelector(".woo-quibuy-close"))||null,this.overlay=(null===(e=this.modal)||void 0===e?void 0:e.querySelector(".woo-quibuy-overlay"))||null,this.btns=document.querySelectorAll(".woo-quibuy-btn"),this.form=document.getElementById("woo-quibuy-checkout-form"),this.initEvents()}return t.prototype.initEvents=function(){var t,e,o,n=this;this.btns.forEach(function(t){t.addEventListener("click",function(t){return n.openModal(t)})}),null===(t=this.closeBtn)||void 0===t||t.addEventListener("click",function(){return n.closeModal()}),null===(e=this.overlay)||void 0===e||e.addEventListener("click",function(){return n.closeModal()}),null===(o=this.form)||void 0===o||o.addEventListener("submit",function(t){return n.submitForm(t)})},t.prototype.openModal=function(t){var e,o=this;t.preventDefault();var n=t.currentTarget,i=n.dataset.product_id,a=n.dataset.product_image,r=n.dataset.product_title,u=parseFloat(n.dataset.product_price||"0"),l=n.dataset.quantityPricing?JSON.parse(n.dataset.quantityPricing):null,d=document.getElementById("woo-quibuy-product-id"),s=document.getElementById("woo-quibuy-quantity");d&&i&&(d.value=i);var c=null===(e=this.modal)||void 0===e?void 0:e.querySelector(".woo-quibuy-product-summary");if(c){c.innerHTML='\n                <div class="woo-quibuy-product-info" style="display: flex; align-items: center; margin-bottom: 20px;">\n                    <div class="woo-quibuy-thumb" style="width: 60px; height: 60px; margin-right: 15px; flex-shrink: 0;">\n                        <img src="'.concat(a,'" alt="').concat(r,'" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">\n                    </div>\n                    <div class="woo-quibuy-details" style="flex-grow: 1;">\n                        <h4 style="margin: 0 0 5px; font-size: 16px;">').concat(r,'</h4>\n                        <div class="woo-quibuy-price-calc" style="display: flex; align-items: center; justify-content: space-between;">\n                            <div class="qty-wrap">\n                                <label style="font-size: 12px; margin-right: 5px;">SL:</label>\n                                <input type="number" id="woo-quibuy-qty-display" value="1" min="1" style="width: 60px; padding: 5px; text-align: center;">\n                            </div>\n                            <div class="total-wrap">\n                                <span id="woo-quibuy-total-price" style="color: #d26e4b; font-weight: bold; font-size: 18px;">\n                                    ').concat(this.formatMoney(u),"\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            ");var y=document.getElementById("woo-quibuy-qty-display"),m=document.getElementById("woo-quibuy-total-price");if(y&&m){var p=function(){var t=parseInt(y.value)||1;t<1&&(t=1),y.value=t.toString(),s&&(s.value=t.toString());var e=u;if(l)for(var n=0,i=Object.keys(l).map(Number).sort(function(t,e){return e-t});n<i.length;n++){var a=i[n];if(t>=a){e=l[a];break}}var r=t*e;m.innerText=o.formatMoney(r),o.triggerCallback(t,r,e)};y.addEventListener("change",p),y.addEventListener("keyup",p)}}this.modal&&(this.modal.style.display="block",this.modal.setAttribute("aria-hidden","false"),document.dispatchEvent(new CustomEvent("woo_quibuy_modal_opened",{detail:{modal:this.modal,productId:i,button:n}})))},t.prototype.formatMoney=function(t){return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(t)},t.prototype.triggerCallback=function(t,e,o){var n=new CustomEvent("woo_quibuy_price_updated",{detail:{quantity:t,total:e,price:o,formattedTotal:this.formatMoney(e)}});document.dispatchEvent(n)},t.prototype.closeModal=function(){this.modal&&(this.modal.style.display="none",this.modal.setAttribute("aria-hidden","true"))},t.prototype.submitForm=function(t){var e=this;if(t.preventDefault(),this.form){var o=new FormData(this.form);o.append("action","woo_quibuy_process_order"),o.append("nonce",wooQuiBuyParams.nonce);var n=this.form.querySelector('button[type="submit"]');n&&(n.disabled=!0,n.innerText="Đang xử lý..."),fetch(wooQuiBuyParams.ajaxurl,{method:"POST",body:o}).then(function(t){return t.json()}).then(function(t){var o;if(t.success)if(t.data.redirect_url)window.location.href=t.data.redirect_url;else{var n=null===(o=e.modal)||void 0===o?void 0:o.querySelector(".woo-quibuy-body");n&&(n.innerHTML='<div class="woo-quibuy-success-message" style="text-align:center; padding: 20px;">\n                                <h4 style="color: green;">'.concat(t.data.message,"</h4>\n                                <p>").concat("Cảm ơn bạn đã đặt hàng.",'</p>\n                                <button class="button woo-quibuy-close-btn" onclick="document.querySelector(\'.woo-quibuy-close\').click()">Đóng</button>\n                            </div>'))}else alert(t.data.message||"Có lỗi xảy ra.")}).catch(function(t){console.error("Error:",t),alert("Có lỗi xảy ra, vui lòng thử lại.")}).finally(function(){n&&(n.disabled=!1,n.innerText="Hoàn tất đơn hàng")})}},t}();document.addEventListener("DOMContentLoaded",function(){new t})})();